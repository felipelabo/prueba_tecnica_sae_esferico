# Prueba T√©cnica - Esf√©rico SAE

## üìã Descripci√≥n

Esta prueba t√©cnica consiste en desarrollar una aplicaci√≥n web con Next.js que permita visualizar usuarios y sus parcelas agr√≠colas en un mapa interactivo.

---

## ‚ö†Ô∏è Notas importantes

- **Si no da tiempo a completar todo**, prioriza las tareas que consideres m√°s importantes. Preferimos ver menos funcionalidades bien implementadas que muchas a medias.
- **Puedes utilizar herramientas de IA** (ChatGPT, Copilot, Claude, etc.) sin ning√∫n problema. Sin embargo, ten en cuenta que posteriormente se realizar√° una entrevista t√©cnica en la que se preguntar√° sobre el c√≥digo desarrollado, por lo que es importante que entiendas todo lo que has implementado.
- **Se valorar√° el uso de Git**: la forma en que estructuras los commits (mensajes claros y descriptivos) y las ramas que creas. Puedes usar GitFlow, trunk-based development o cualquier estrategia de branching que consideres apropiada.

---

## üöÄ Setup

### Requisitos previos

- Node.js (v20.9 o superior)
- pnpm o npm
- Docker y Docker Compose

### Instalaci√≥n

1. **Configurar variables de entorno:**

   ```bash
   cp env.development.example .env.development
   cp env.test.example .env.test
   ```

2. **Instalar dependencias:**

   ```bash
   pnpm install
   # o
   npm install
   ```
3. **Levantar la base de datos PostgreSQL con PostGIS:**

   ```bash
   docker compose up -d
   ```
4. **Ejecutar migraciones en la base de datos de desarrollo:**

   ```bash
   pnpm run prisma:migrate:dev
   # o
   npm run prisma:migrate:dev
   ```
5. **Ejecutar migraciones en la base de datos de test:**

   ```bash
   pnpm run prisma:migrate:test
   # o
   npm run prisma:migrate:test
   ```
5. **Generar el cliente de Prisma:**

   ```bash
   pnpm run prisma:generate
   # o
   npm run prisma:generate
   ```
6. **Iniciar el servidor de desarrollo:**

   ```bash
   pnpm run dev
   # o
   npm run dev
   ```

La aplicaci√≥n estar√° disponible en `http://localhost:3000`.

---

## üìù Tareas a realizar

### 1. Completar el script de seedeo

**Archivo:** `/prisma/seed/seed.ts`

Completa el script de seed para poblar la base de datos con datos de prueba. Deber√°s crear:

- **Provincias y Municipios**
- **Usuarios** (al menos 6 - 7 usuarios de ejemplo)
- **Cultivos** (tipos de cultivo: trigo, ma√≠z, olivo, etc.)
- **Parcelas** con geometr√≠as de pol√≠gonos (asociadas a usuarios y municipios)
- **Recintos** dentro de las parcelas (asociados a cultivos)

**Instrucciones:**

- Para las tablas sin geometr√≠as, usa el cliente de Prisma normalmente. Consulta la [documentaci√≥n de CRUD](https://www.prisma.io/docs/orm/prisma-client/queries/crud).
- Para insertar pol√≠gonos, usa raw queries con la funci√≥n `ST_GeomFromGeoJSON` de PostGIS. Consulta la [documentaci√≥n de raw queries](https://www.prisma.io/docs/orm/prisma-client/using-raw-sql/raw-queries) y la [documentaci√≥n de ST_GeomFromGeoJSON](https://postgis.net/docs/ST_GeomFromGeoJSON.html).
- Puedes crear pol√≠gonos de prueba f√°cilmente con esta herramienta: [geojson.io](https://geojson.io/#map=5/39.25/-5.56)

**Nota:** Los recintos deben estar geom√©tricamente contenidos dentro de sus parcelas (existe un constraint que lo valida con `ST_Within`).

---

### 2. Vista de listado de usuarios

**Ruta:** `/users`

Crea una vista que muestre un listado de usuarios en formato de tarjetas (cards).

**Requisitos:**

- Mostrar datos **no sensibles** de los usuarios (nombre, email, n√∫mero de parcelas, etc.)
- **NO mostrar** el password ni datos sensibles
- Al hacer clic en una tarjeta, navegar a la vista del mapa del usuario (`/user/:id`)

**Bonus (opcional):**

- Crear un modelo `Profile` con relaci√≥n 1:1 con `Usuario` que incluya un campo `imagen`
- Renderizar la imagen del perfil en las tarjetas de usuario utilizando los componentes espec√≠ficos para im√°genes de NextJS

---

### 3. Vista de mapa con parcelas y recintos

**Ruta:** `/user/:id`

Crea una vista con un mapa de Leaflet que muestre las parcelas y recintos del usuario.

**Requisitos:**

- Usar la librer√≠a [react-leaflet](https://react-leaflet.js.org/) para renderizar el mapa
- Mostrar las **parcelas** del usuario como pol√≠gonos en el mapa
- Mostrar los **recintos** dentro de cada parcela (con un color diferente para distinguirlos)
- Al hacer **hover** sobre una parcela o recinto, mostrar informaci√≥n de la base de datos:
  - **Parcela:** municipio, provincia, n√∫mero de recintos
  - **Recinto:** cultivo, fecha de siembra, fecha de cosecha
- La informaci√≥n puede mostrarse dentro del mapa (tooltip/popup) o fuera (panel lateral), a tu elecci√≥n

---

### 4. Tests con Jest

**Carpeta:** `/__tests__/`

Crea al menos **3 tests** utilizando Jest (ya configurado en el proyecto).

**Ejemplos de tests v√°lidos:**

- **Test de renderizado:** Verificar que la p√°gina de usuarios (`/users`) renderiza correctamente las tarjetas de usuario
- **Test de navegaci√≥n:** Comprobar que al hacer clic en una tarjeta de usuario se navega a la ruta correcta (`/user/:id`)
- **Test de componente:** Verificar que el componente del mapa muestra el n√∫mero correcto de parcelas y recintos, y que dichas parcelas y recintos solo pertenecen a dicho usuario y no a otro.
- **Test de datos:** Verificar que los datos mostrados en las tarjetas no incluyen informaci√≥n sensible

**Ejecutar tests:**

```bash
pnpm run test
# o
npm run test
```

---

## üìä Modelo de datos

```
Provincia (1) ‚îÄ‚îÄ‚îÄ‚îÄ (N) Municipio
                         ‚îÇ
                         ‚îÇ (1)
                         ‚ñº
Usuario (1) ‚îÄ‚îÄ‚îÄ‚îÄ (N) Parcela (1) ‚îÄ‚îÄ‚îÄ‚îÄ (N) Recinto (N) ‚îÄ‚îÄ‚îÄ‚îÄ (1) Cultivo
```

- **Provincia:** id, nombre
- **Municipio:** id, nombre, provinciaId
- **Usuario:** id, nombre, email, password
- **Parcela:** id, geom (Polygon), usuarioId, municipioId
- **Recinto:** id, geom (Polygon), parcelaId, cultivoId, fechaSiembra, fechaCosecha
- **Cultivo:** id, nombre

---

## üõ†Ô∏è Tecnolog√≠as

- **Framework:** Next.js 16
- **ORM:** Prisma 7
- **Base de datos:** PostgreSQL 18 + PostGIS 3.6
- **Mapas:** Leaflet / react-leaflet
- **Estilos:** CSS Modules / SCSS / Tailwind

---

## ‚å®Ô∏è Comandos √∫tiles

### Prisma

| Comando                          | Descripci√≥n                                                                                  |
| -------------------------------- | --------------------------------------------------------------------------------------------- |
| `pnpm run prisma:generate`     | Regenera el cliente de Prisma despu√©s de cambios en el schema                                |
| `pnpm run prisma:migrate:dev`  | Crea y aplica una nueva migraci√≥n en desarrollo                                              |
| `pnpm run prisma:migrate:test` | Aplica migraciones en la base de datos de test                                                |
| `pnpm run prisma:reset:dev`    | Resetea la base de datos de desarrollo (borra todos los datos y re-aplica migraciones + seed) |
| `pnpm run prisma:reset:test`   | Resetea la base de datos de test                                                              |

### Docker

| Comando                    | Descripci√≥n                                                                     |
| -------------------------- | -------------------------------------------------------------------------------- |
| `docker compose up -d`   | Levanta los contenedores en segundo plano                                        |
| `docker compose down`    | Para y elimina los contenedores                                                  |
| `docker compose down -v` | Para los contenedores y elimina los vol√∫menes (borra datos de la base de datos) |
| `docker compose logs -f` | Muestra los logs de los contenedores en tiempo real                              |

### Tests

| Comando                         | Descripci√≥n                                                |
| ------------------------------- | ----------------------------------------------------------- |
| `pnpm run test`               | Ejecuta todos los tests                                     |
| `pnpm run test -- --watch`    | Ejecuta tests en modo watch (re-ejecuta al guardar cambios) |
| `pnpm run test -- --coverage` | Ejecuta tests y genera reporte de cobertura                 |

---

## üìö Recursos √∫tiles

- [Documentaci√≥n de Next.js](https://nextjs.org/docs)
- [Documentaci√≥n de Prisma](https://www.prisma.io/docs)
- [Documentaci√≥n de react-leaflet](https://react-leaflet.js.org/)
- [Documentaci√≥n de PostGIS](https://postgis.net/documentation/)
- [Herramienta para crear GeoJSON](https://geojson.io/)

---

## ‚úÖ Criterios de evaluaci√≥n

- C√≥digo limpio y bien estructurado
- Uso correcto de TypeScript
- Manejo adecuado de datos geoespaciales
- Experiencia de usuario en la visualizaci√≥n del mapa
- Bonus: Tests, manejo de errores, optimizaciones

¬°Buena suerte! üçÄ
